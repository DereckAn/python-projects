<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="/JS/Core"></script>
    <script type="text/javascript">
      function getCoordenates(lineString) {
        var coords = lineString.slice(11, -1).split(",");
        var coordList = coords.map((coord) => {
          var parts = coord.trim().split(" ");
          return [parseFloat(parts[1]), parseFloat(parts[0])];
        });
        return coordList;
      }

      function rotate(origin, point, angle) {
        let radians = (angle * Math.PI) / 180.0;
        let nx =
          Math.cos(radians) * (point[0] - origin[0]) -
          Math.sin(radians) * (point[1] - origin[1]) +
          origin[0];
        let ny =
          Math.sin(radians) * (point[0] - origin[0]) +
          Math.cos(radians) * (point[1] - origin[1]) +
          origin[1];
        return [nx, ny];
      }

      function rotateLineString(lineString) {
        let gradesInput = document.getElementById("gradesInput")
          .value;
        let lonList = [];
        let latList = [];
        lineString.forEach((coord) => {
          lonList.push(parseFloat(coord[0]));
          latList.push(parseFloat(coord[1]));
        });

        let origin = [
          (Math.max(...lonList) + Math.min(...lonList)) / 2,
          (Math.max(...latList) + Math.min(...latList)) / 2,
        ];

        let rotatedCoords = lineString.map((coord) =>
          rotate(origin, coord, gradesInput)
        );
        return rotatedCoords;
      }

      function convertLineStringToObj(newCoords) {
        return {
          data: [[newCoords, "Lines"]],
          columns: [{ name: "geom" }, { name: "name" }],
        };
      }

      function dataToDisplay(options) {
        let lineStringExample = document.getElementById("lineStringInput")
          .value;
        let rotatedCoords = rotateLineString(getCoordenates(lineStringExample));
        let lineObj = convertLineStringToObj(rotatedCoords);
        return lineObj;
      }

      function drawMap() {
        var map = ml.map("mapDiv");
        var layer = ml.layer(map, {
          query: {
            select: {
              type: "geo.client.line",
            },
            table: {
              retrieveData: dataToDisplay,
            },
          },
          style: {
            method: "rules",
            rules: [
              {
                style: {
                  fillColor: "128-128-0-255",
                  width: 5,
                },
                where: {
                  col: "*",
                  test: "CatchAll",
                  value: 0,
                },
                constraint: {},
              },
            ],
          },
          visible: true,
          onClick: "template",
          clickTemplate: "{name}",
          onHover: "template",
          hoverTemplate: "{name}",
          hoverFieldsCommaDel: "name",
        });
      }

      ml.onload(drawMap);
    </script>
  </head>
  <body>
    <div
      style="
        position: absolute;
        display: flex;
        flex-direction: column;
        z-index: 10000;
        background-color: transparent;
        top: 80%;
        left: 40%;
        border: 2px solid red;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
        padding: 20px;
        gap: 5px;
        border-radius: 10px;
      "
    >
      <label for="lineStringInput">Ingrese LineString:</label>
      <input type="text" id="lineStringInput" name="lineStringInput" />
      <input type="number" id="gradesInput" name="gradesInput" />
      <button onclick="drawMap()">Dibujar Mapa</button>
    </div>
    <div id="mapDiv" style="width: 100%; height: 100%;"></div>
  </body>
</html>
